%% Load data
addpath(genpath('./helpers'));
[trainingImages,trainingLabels,validationImages,validationLabels] = loadCifar10Data();
[ny,nx,nz] = size(validationImages(:,:,:,1));
%% Train the network. 
options = trainingOptions('sgdm','MaxEpochs',50,...
	'InitialLearnRate',0.005,...
    'shuffle', 'every-epoch',...
    'ValidationFrequency', 250,...
    'ValidationPatience', Inf,...
    'LearnRateSchedule','piecewise',...
    'LearnRateDropFactor',0.7,...
    'LearnRateDropPeriod',5,...
    'ValidationData',{validationImages,validationLabels});  

% ours:
layers = ourArchitecture(ny,nx,nz);
[ourNet, ourInfo] = trainNetwork(trainingImages,trainingLabels,layers,options);

% mnistExperts:
layers = nmistExpertsArchitecture(ny,nx,nz);
[mnistTypeNet, mnistTypeInfo] = trainNetwork(trainingImages,trainingLabels,layers,options);

% relatedBig:
layers = relatedArchitectureBig(ny,nx,nz);
[bigNet, bigInfo] = trainNetwork(trainingImages,trainingLabels,layers,options);

% relatedSmall:
layers = relatedArchitectureSmall(ny,nx,nz);
[smallNet, smallInfo] = trainNetwork(trainingImages,trainingLabels,layers,options);
%% save results
save('cifar10_results', 'ourNet','ourInfo',...
    'mnistTypeNet', 'mnistTypeInfo',...
    'bigNet','bigInfo',...
    'smallNet','smallInfo');
